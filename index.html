<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Anime List</title>

<style>
:root{
  --accent:#a855f7;
  --glass:rgba(255, 255, 255, 0.10);
  --border:rgba(255, 255, 255, 0.25);
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
}

body{
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
    "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  min-height:100vh;
  background:url("color1.avif") no-repeat center center fixed;
  background-size:cover;
  color:#e9f3ef;
  position:relative;
}

/* Fallback background */
body::before{
  content:'';
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);
  z-index:-1;
}

.page{
  width:92%;
  max-width:1300px;
  margin:auto;
  padding:20px 0 60px;
}

.header{
  margin:30px 0;
  transition:all 0.3s ease;
  background: var(--glass);
  backdrop-filter: blur(20px) saturate(180%);
  border-radius: 28px;
  border: 1px solid var(--border);
  padding: 40px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
}

.header.focused{
  transform:translateY(-5px);
  box-shadow: 0 15px 50px rgba(0, 0, 0, 0.45);
}

h1{
  text-align: center;
  font-size: 2rem;
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 30px;
  text-shadow:2px 2px 8px rgba(0,0,0,0.5);
}

.search-bar{
  display:flex;
  gap:10px;
  flex-direction:column;
  position:relative;
}

.search-row{
  display:flex;
  gap:10px;
}

.search-row input{
  flex:1;
  padding:12px 16px;
  border-radius:14px;
  border:none;
  background:rgba(255, 255, 255, 0.18);
  color:#fff;
  font-size:16px;
  transition:all 0.3s ease;
  outline:none;
}

.search-row input::placeholder{
  color:#d8e3de;
}

.search-row input:focus{
  background:rgba(255, 255, 255, 0.25);
  box-shadow:0 0 20px rgba(168,85,247,0.3);
}

.add-btn{
  width:48px;
  height:48px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.06);
  backdrop-filter:blur(6px);
  color:white;
  font-size:28px;
  cursor:pointer;
  transition:all 0.18s ease;
  display:flex;
  align-items:center;
  justify-content:center;
}

.add-btn:hover{
  transform:translateY(-2px);
  background:rgba(255,255,255,0.10);
  box-shadow:0 4px 20px rgba(168,85,247,0.4);
}

.autocomplete{
  background:var(--glass);
  backdrop-filter:blur(20px) saturate(180%);
  border-radius:14px;
  border:1px solid var(--border);
  overflow:hidden;
  max-height:300px;
  overflow-y:auto;
  display:none;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
}

.autocomplete.show{
  display:block;
}

.autocomplete div{
  padding:12px 16px;
  cursor:pointer;
  transition:background 0.18s;
  display:flex;
  align-items:center;
  gap:12px;
}

.autocomplete div:hover{
  background:rgba(255,255,255,.1);
}

.autocomplete div img{
  width:40px;
  height:56px;
  object-fit:cover;
  border-radius:6px;
}

.section{
  margin-top:30px;
  background:var(--glass);
  backdrop-filter:blur(20px) saturate(180%);
  border-radius:28px;
  padding:40px;
  border:1px solid var(--border);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
  transition:all 0.3s ease;
}

.badge{
  padding:10px 22px;
  border-radius:999px;
  font-weight:600;
  display:inline-block;
  font-size:15px;
  border:1px solid rgba(255,255,255,0.3);
  backdrop-filter:blur(6px);
}

.peak{
  background:rgba(255, 153, 0, 0.2);
  color:#ffb347;
  border-color:#ff9900;
}

.watched{
  background:rgba(168, 85, 247, 0.2);
  color:#c4b5fd;
  border-color:#a855f7;
}

.row{
  display:flex;
  gap:16px;
  overflow-x:auto;
  margin-top:20px;
  padding:8px 0;
}

.row::-webkit-scrollbar{
  height:8px;
}

.row::-webkit-scrollbar-track{
  background:rgba(255,255,255,0.05);
  border-radius:10px;
}

.row::-webkit-scrollbar-thumb{
  background:var(--accent);
  border-radius:10px;
}

.card{
  min-width:170px;
  background:rgba(20, 30, 25, 0.55);
  border-radius:18px;
  overflow:hidden;
  cursor:pointer;
  transition:all 0.18s ease;
  border:1px solid rgba(255, 255, 255, 0.20);
}

.card:hover{
  transform:translateY(-5px);
  box-shadow:0 8px 24px rgba(168,85,247,0.3);
  border-color:var(--accent);
}

.card img{
  width:100%;
  height:240px;
  object-fit:cover;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
}

.card img.loading{
  background:linear-gradient(90deg,#2a2a3e 0%,#3a3a4e 50%,#2a2a3e 100%);
  background-size:200% 100%;
  animation:shimmer 1.5s infinite;
}

@keyframes shimmer{
  0%{background-position:-200% 0}
  100%{background-position:200% 0}
}

.card-content{
  padding:12px;
  font-size:14px;
  font-weight:500;
  text-align:center;
  color:#e5f1eb;
}

/* Modal Styles */
.modal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.7);
  backdrop-filter:blur(8px);
  z-index:1000;
  align-items:center;
  justify-content:center;
}

.modal.show{
  display:flex;
}

.modal-content{
  background:var(--glass);
  backdrop-filter:blur(20px) saturate(180%);
  border-radius:28px;
  border:1px solid var(--border);
  width:90%;
  max-width:500px;
  max-height:90vh;
  overflow-y:auto;
  animation:slideUp 0.3s ease;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
}

@keyframes slideUp{
  from{
    opacity:0;
    transform:translateY(30px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

.modal-header{
  padding:24px;
  border-bottom:1px solid rgba(255, 255, 255, 0.3);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.modal-header h2{
  font-size:1.5rem;
  color:#ffffff;
  font-weight:600;
}

.close-btn{
  background:none;
  border:none;
  color:white;
  font-size:28px;
  cursor:pointer;
  padding:0;
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
  transition:background 0.18s;
}

.close-btn:hover{
  background:rgba(255,255,255,0.1);
}

.modal-body{
  padding:24px;
}

.anime-detail-img{
  width:100%;
  height:300px;
  object-fit:cover;
  border-radius:16px;
  margin-bottom:16px;
  border:1px solid rgba(255, 255, 255, 0.20);
}

.anime-detail-title{
  font-size:1.5rem;
  font-weight:600;
  margin-bottom:20px;
  text-align:center;
  color:#ffffff;
}

.users-opinions{
  background:rgba(20, 30, 25, 0.55);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  border:1px solid rgba(255, 255, 255, 0.20);
}

.users-opinions h4{
  color:#e9f3ef;
  font-size:0.9rem;
  margin-bottom:12px;
}

.user-oval{
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 16px;
  background:rgba(255,255,255,0.08);
  border-radius:999px;
  margin-bottom:10px;
}

.user-oval:last-child{
  margin-bottom:0;
}

.username{
  font-weight:600;
  color:var(--accent);
  min-width:80px;
}

.opinion{
  flex:1;
  font-size:14px;
  color:#ddd;
}

.rating-section{
  text-align:center;
  margin-top:20px;
  background:rgba(20, 30, 25, 0.55);
  border-radius:16px;
  padding:18px;
  border:1px solid rgba(255, 255, 255, 0.20);
}

.rating-section h4{
  color:#e9f3ef;
  font-size:0.9rem;
  margin-bottom:8px;
}

.stars{
  font-size:24px;
  color:#fbbf24;
}

.category-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
  gap:10px;
  margin-top:16px;
}

.category-checkbox{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px;
  background:rgba(255,255,255,0.08);
  border-radius:10px;
  cursor:pointer;
  transition:all 0.18s;
  border:1px solid rgba(255, 255, 255, 0.15);
}

.category-checkbox:hover{
  background:rgba(255,255,255,0.15);
}

.category-checkbox input{
  cursor:pointer;
  accent-color:#b2d6c7;
  transform:scale(1.2);
}

.form-group{
  margin-bottom:16px;
}

.form-group label{
  display:block;
  margin-bottom:8px;
  font-weight:500;
  color:#e9f3ef;
  font-size:0.9rem;
}

.form-group input,.form-group textarea,.form-group select{
  width:100%;
  padding:12px 14px;
  border-radius:14px;
  border:none;
  background:rgba(255, 255, 255, 0.18);
  color:#fff;
  font-family:inherit;
  outline:none;
}

.form-group input::placeholder,.form-group textarea::placeholder{
  color:#d8e3de;
}

.form-group textarea{
  resize:vertical;
  min-height:80px;
}

.form-group select{
  cursor:pointer;
}

.submit-btn{
  width:100%;
  padding:12px 20px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(168, 85, 247, 0.2);
  color:#ffffff;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.18s ease;
  backdrop-filter:blur(6px);
}

.submit-btn:hover{
  transform:translateY(-2px);
  background:rgba(168, 85, 247, 0.3);
  box-shadow:0 6px 20px rgba(168,85,247,0.4);
}

/* Peak toggle button */
.peak-toggle-btn{
  width:100%;
  padding:12px 20px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255, 153, 0, 0.2);
  color:#ffb347;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.18s ease;
  backdrop-filter:blur(6px);
  margin-bottom:12px;
}

.peak-toggle-btn:hover{
  transform:translateY(-2px);
  background:rgba(255, 153, 0, 0.3);
  box-shadow:0 6px 20px rgba(255,153,0,0.4);
}

.peak-toggle-btn.is-peak{
  background:rgba(16, 185, 129, 0.2);
  color:#34d399;
  border-color:#10b981;
}

.peak-toggle-btn.is-peak:hover{
  background:rgba(16, 185, 129, 0.3);
  box-shadow:0 6px 20px rgba(16,185,129,0.4);
}

/* Add opinion section */
.add-opinion-section{
  background:rgba(20, 30, 25, 0.55);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  border:1px solid rgba(255, 255, 255, 0.20);
}

.add-opinion-section h4{
  color:#e9f3ef;
  font-size:0.9rem;
  margin-bottom:12px;
}

.opinion-input-group{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-bottom:10px;
}

.opinion-input-row{
  display:flex;
  gap:8px;
}

.opinion-input-group select{
  padding:10px 12px;
  border-radius:10px;
  border:none;
  background:rgba(255, 255, 255, 0.18);
  color:white;
  font-family:inherit;
  outline:none;
  cursor:pointer;
}

.opinion-input-group input{
  flex:1;
  padding:10px 12px;
  border-radius:10px;
  border:none;
  background:rgba(255, 255, 255, 0.18);
  color:white;
  font-family:inherit;
  outline:none;
}

.opinion-input-group input::placeholder{
  color:#d8e3de;
}

.opinion-input-group button{
  padding:10px 20px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(168, 85, 247, 0.2);
  color:white;
  font-weight:600;
  cursor:pointer;
  transition:all 0.18s ease;
  backdrop-filter:blur(6px);
}

.opinion-input-group button:hover{
  transform:translateY(-2px);
  background:rgba(168, 85, 247, 0.3);
}

/* Loading indicator */
.loading{
  text-align:center;
  padding:20px;
  color:#aaa;
}

/* Responsive */
@media (max-width:768px){
  h1{
    font-size:1.75rem;
  }
  
  .header, .section{
    padding:25px;
  }
  
  .card{
    min-width:140px;
  }
  
  .card img{
    height:200px;
  }
  
  .modal-content{
    width:95%;
  }
}
</style>
</head>

<body>
<div class="page">
  <div class="header" id="header">
    <h1>üéå My Anime List</h1>
    <div class="search-bar">
      <div class="search-row">
        <input id="search" placeholder="Search anime... (use Tab to navigate)" autocomplete="off">
        <button class="add-btn" id="addBtn">+</button>
      </div>
      <div id="autocomplete" class="autocomplete"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:15px;justify-content:center;flex-wrap:wrap;">
      <button onclick="exportData()" style="padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:white;cursor:pointer;font-size:14px;backdrop-filter:blur(6px);">üíæ Export Data</button>
      <button onclick="importData()" style="padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:white;cursor:pointer;font-size:14px;backdrop-filter:blur(6px);">üì• Import Data</button>
      <button onclick="resetData()" style="padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,0,0,0.15);color:#ff6b6b;cursor:pointer;font-size:14px;backdrop-filter:blur(6px);">üóëÔ∏è Reset</button>
    </div>
  </div>

  <div class="section">
    <span class="badge peak">üî• Peak</span>
    <div id="peak" class="row"></div>
  </div>

  <div class="section">
    <span class="badge watched">üëÅÔ∏è Watched</span>
    <div id="watched" class="row"></div>
  </div>
</div>

<!-- Add Anime Modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New Anime</h2>
      <button class="close-btn" onclick="closeAddModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addAnimeForm">
        <div class="form-group">
          <label>Anime Title</label>
          <input type="text" id="animeTitle" required readonly>
        </div>
        
        <div class="form-group">
          <label>Categories</label>
          <div class="category-grid" id="categoryGrid"></div>
        </div>
        
        <div class="form-group">
          <label>Watched By</label>
          <select id="watchedBy" multiple style="height:100px">
            <option value="Rayyy">Rayyy</option>
            <option value="Shafaa">Shafaa</option>
          </select>
          <small style="color:#d8e3de;font-size:12px">Hold Ctrl/Cmd to select multiple</small>
        </div>
        
        <div class="form-group">
          <label>Your Opinion</label>
          <textarea id="opinion" placeholder="What did you think about this anime?"></textarea>
        </div>
        
        <div class="form-group">
          <label>Rating (1-5 stars)</label>
          <input type="number" id="rating" min="1" max="5" value="3">
        </div>
        
        <div class="form-group">
          <label>Status</label>
          <select id="status">
            <option value="Watched">Watched</option>
            <option value="Peak">Peak</option>
            <option value="Hold">On Hold</option>
          </select>
        </div>
        
        <button type="submit" class="submit-btn">Add to List</button>
      </form>
    </div>
  </div>
</div>

<!-- Anime Detail Modal -->
<div id="detailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Anime Details</h2>
      <button class="close-btn" onclick="closeDetailModal()">&times;</button>
    </div>
    <div class="modal-body" id="detailBody">
      <!-- Content will be dynamically inserted -->
    </div>
  </div>
</div>

<script>
const ANIME_CATEGORIES = [
  "Action","Adventure","Comedy","Drama","Fantasy","Horror",
  "Isekai","Magic","Mecha","Mystery","Romance","School",
  "Sci-Fi","Slice of Life","Sports","Supernatural","Thriller"
];

// Default anime data
const defaultAnimeData = [
  {"title":"Seirei Genosouki","malId":42755,"genres":["Isekai"],"rayyy":"Watched","shafaa":"","rating":4,"opinions":{"Rayyy":"Pretty good isekai"}},
  {"title":"The Rising of the Shield Hero","malId":35790,"genres":["Isekai"],"rayyy":"Watched","shafaa":"","rating":5,"opinions":{"Rayyy":"Epic!"}},
  {"title":"Chivalry of a Failed Knight","malId":30296,"genres":["Action","Fantasy"],"rayyy":"Watched","shafaa":"","rating":4},
  {"title":"Ao Ashi","malId":49052,"genres":["Sports"],"rayyy":"Watched","shafaa":"","rating":4},
  {"title":"Haikyu!!","malId":20583,"genres":["Sports"],"rayyy":"Watched","shafaa":"","rating":5},
  {"title":"The Angel Next Door Spoils Me Rotten","malId":49909,"genres":["Romance"],"rayyy":"Watched","shafaa":"","rating":5},
  {"title":"Frieren: Beyond Journey's End","malId":52991,"genres":["Adventure"],"rayyy":"Watched","shafaa":"Watched","rating":5,"opinions":{"Rayyy":"Masterpiece","Shafaa":"Beautiful story"}},
  {"title":"Re:Zero","malId":31240,"genres":["Isekai"],"rayyy":"Watched","shafaa":"","rating":5},
  {"title":"That Time I Got Reincarnated as a Slime","malId":37430,"genres":["Isekai"],"rayyy":"Watched","shafaa":"","rating":5},
  {"title":"Your Lie in April","malId":23273,"genres":["Romance"],"rayyy":"Watched","shafaa":"","rating":5},
  {"title":"Made in Abyss","malId":34599,"genres":["Adventure"],"rayyy":"Watched","shafaa":"","rating":5},
  {"title":"My Dress-Up Darling","malId":48736,"genres":["Romance","Slice of Life"],"rayyy":"Watched","shafaa":"Watched","rating":5},
  {"title":"Zom 100: Bucket List of the Dead","malId":54112,"genres":["Action","Comedy"],"rayyy":"Watched","shafaa":"","rating":4},
  {"title":"Fog Hill of Five Elements","malId":39411,"genres":["Action","Fantasy"],"rayyy":"Watched","shafaa":"","rating":4},
  {"title":"Fire Force","malId":38671,"genres":["Action","Supernatural"],"rayyy":"Watched","shafaa":"Watched","rating":4},
  {"title":"Blue Lock","malId":49596,"genres":["Sports"],"rayyy":"Watched","shafaa":"","rating":5},
  {"title":"Black Clover","malId":34572,"genres":["Action","Fantasy"],"rayyy":"Watched","shafaa":"","rating":4},
  {"title":"Akame ga Kill!","malId":22199,"genres":["Action","Fantasy"],"rayyy":"Watched","shafaa":"Hold","rating":4},
  {"title":"Violet Evergarden","malId":33352,"genres":["Drama","Slice of Life"],"rayyy":"","shafaa":"Watched","rating":5},
  {"title":"The Apothecary Diaries","malId":54492,"genres":["Historical","Drama"],"rayyy":"Watched","shafaa":"Watched","rating":5},
  {"title":"Undead Unluck","malId":54791,"genres":["Action","Supernatural"],"rayyy":"Watched","shafaa":"Watched","rating":4},
  {"title":"Shugo-Chara!","malId":2923,"genres":["Magic","School"],"rayyy":"","shafaa":"Watched","rating":4}
];

// Load anime data from localStorage or use default
let animeData = JSON.parse(localStorage.getItem('animeList')) || defaultAnimeData;

// Save data to localStorage
function saveData() {
  localStorage.setItem('animeList', JSON.stringify(animeData));
}

// Image cache
const imageCache = new Map();
let selectedAutocompleteIndex = -1;
let autocompleteResults = [];
let currentAnime = null;

// Elements
const searchInput = document.getElementById('search');
const autocompleteDiv = document.getElementById('autocomplete');
const addBtn = document.getElementById('addBtn');
const peakContainer = document.getElementById('peak');
const watchedContainer = document.getElementById('watched');
const header = document.getElementById('header');

// Fetch anime image with cache and retry
async function fetchAnimeImage(title, malId = null, retries = 3) {
  const cacheKey = malId || title;
  
  if (imageCache.has(cacheKey)) {
    return imageCache.get(cacheKey);
  }

  for (let i = 0; i < retries; i++) {
    try {
      let response;
      
      // If we have MAL ID, use it directly for better accuracy
      if (malId) {
        response = await fetch(`https://api.jikan.moe/v4/anime/${malId}`);
        if (response.ok) {
          const data = await response.json();
          const imageUrl = data.data?.images?.jpg?.large_image_url || 
                         data.data?.images?.jpg?.image_url || 
                         'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22170%22 height=%22240%22%3E%3Crect fill=%22%23667eea%22 width=%22100%25%22 height=%22100%25%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E';
          imageCache.set(cacheKey, imageUrl);
          return imageUrl;
        }
      }
      
      // Fallback to search by title
      response = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(title)}&limit=1&order_by=popularity`);
      if (!response.ok) throw new Error('Network error');
      
      const data = await response.json();
      const imageUrl = data.data?.[0]?.images?.jpg?.large_image_url || 
                       data.data?.[0]?.images?.jpg?.image_url || 
                       'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22170%22 height=%22240%22%3E%3Crect fill=%22%23667eea%22 width=%22100%25%22 height=%22100%25%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E';
      
      imageCache.set(cacheKey, imageUrl);
      return imageUrl;
    } catch (err) {
      if (i < retries - 1) {
        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
      }
    }
  }
  
  // Return placeholder if all retries fail
  return 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22170%22 height=%22240%22%3E%3Crect fill=%22%23667eea%22 width=%22100%25%22 height=%22100%25%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E';
}

// Search autocomplete
let searchTimeout;
searchInput.addEventListener('input', async (e) => {
  clearTimeout(searchTimeout);
  const query = e.target.value.trim();
  
  if (query.length < 1) {
    autocompleteDiv.classList.remove('show');
    return;
  }
  
  searchTimeout = setTimeout(async () => {
    try {
      const response = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(query)}&limit=15&order_by=popularity`);
      const data = await response.json();
      autocompleteResults = data.data || [];
      
      if (autocompleteResults.length > 0) {
        autocompleteDiv.innerHTML = autocompleteResults.map((anime, idx) => `
          <div data-index="${idx}" data-title="${anime.title}" data-mal-id="${anime.mal_id}">
            <img src="${anime.images.jpg.small_image_url || anime.images.jpg.image_url}" alt="${anime.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2256%22%3E%3Crect fill=%22%23667eea%22 width=%22100%25%22 height=%22100%25%22/%3E%3C/svg%3E'">
            <span>${anime.title}</span>
          </div>
        `).join('');
        autocompleteDiv.classList.add('show');
        selectedAutocompleteIndex = -1;
      } else {
        autocompleteDiv.innerHTML = '<div style="padding:12px;color:#aaa;">No results found</div>';
        autocompleteDiv.classList.add('show');
      }
    } catch (err) {
      console.error('Search error:', err);
      autocompleteDiv.innerHTML = '<div style="padding:12px;color:#aaa;">Error searching. Try again.</div>';
      autocompleteDiv.classList.add('show');
    }
  }, 400);
});

// Tab navigation in autocomplete
searchInput.addEventListener('keydown', (e) => {
  const items = autocompleteDiv.querySelectorAll('div');
  
  if (e.key === 'Tab' && autocompleteDiv.classList.contains('show')) {
    e.preventDefault();
    selectedAutocompleteIndex = (selectedAutocompleteIndex + 1) % items.length;
    
    items.forEach((item, idx) => {
      if (idx === selectedAutocompleteIndex) {
        item.style.background = 'rgba(168,85,247,0.3)';
        searchInput.value = item.dataset.title;
      } else {
        item.style.background = '';
      }
    });
  } else if (e.key === 'Enter' && selectedAutocompleteIndex >= 0) {
    e.preventDefault();
    const selectedTitle = items[selectedAutocompleteIndex].dataset.title;
    openAddModal(selectedTitle);
  }
});

// Tab navigation in autocomplete
searchInput.addEventListener('keydown', (e) => {
  const items = autocompleteDiv.querySelectorAll('div[data-title]');
  
  if (e.key === 'Tab' && autocompleteDiv.classList.contains('show') && items.length > 0) {
    e.preventDefault();
    selectedAutocompleteIndex = (selectedAutocompleteIndex + 1) % items.length;
    
    items.forEach((item, idx) => {
      if (idx === selectedAutocompleteIndex) {
        item.style.background = 'rgba(168,85,247,0.3)';
        searchInput.value = item.dataset.title;
      } else {
        item.style.background = '';
      }
    });
  } else if (e.key === 'Enter' && selectedAutocompleteIndex >= 0 && items.length > 0) {
    e.preventDefault();
    const selectedTitle = items[selectedAutocompleteIndex].dataset.title;
    const selectedMalId = items[selectedAutocompleteIndex].dataset.malId;
    openAddModal(selectedTitle, selectedMalId);
  }
});

// Click autocomplete item
autocompleteDiv.addEventListener('click', (e) => {
  const item = e.target.closest('[data-title]');
  if (item) {
    const malId = item.dataset.malId;
    openAddModal(item.dataset.title, malId);
  }
});

// Focus management
searchInput.addEventListener('focus', () => {
  header.classList.add('focused');
});

searchInput.addEventListener('blur', () => {
  setTimeout(() => {
    header.classList.remove('focused');
    autocompleteDiv.classList.remove('show');
  }, 200);
});

// Add button click
addBtn.addEventListener('click', async () => {
  if (searchInput.value.trim()) {
    openAddModal(searchInput.value.trim());
  } else {
    // Random anime if search is empty
    try {
      const response = await fetch('https://api.jikan.moe/v4/random/anime');
      const data = await response.json();
      if (data.data) {
        openAddModal(data.data.title, data.data.mal_id);
      }
    } catch (err) {
      console.error('Error fetching random anime:', err);
      alert('Failed to fetch random anime. Please try again.');
    }
  }
});

// Open add modal
function openAddModal(title, malId = null) {
  document.getElementById('animeTitle').value = title;
  document.getElementById('animeTitle').dataset.malId = malId || '';
  
  // Populate categories
  const categoryGrid = document.getElementById('categoryGrid');
  categoryGrid.innerHTML = ANIME_CATEGORIES.map(cat => `
    <label class="category-checkbox">
      <input type="checkbox" name="category" value="${cat}">
      <span>${cat}</span>
    </label>
  `).join('');
  
  document.getElementById('addModal').classList.add('show');
  autocompleteDiv.classList.remove('show');
  searchInput.value = '';
}

function closeAddModal() {
  document.getElementById('addModal').classList.remove('show');
}

// Submit add anime form
document.getElementById('addAnimeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const title = document.getElementById('animeTitle').value;
  const malId = document.getElementById('animeTitle').dataset.malId || null;
  const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
    .map(cb => cb.value);
  const watchedBy = Array.from(document.getElementById('watchedBy').selectedOptions)
    .map(opt => opt.value);
  const opinion = document.getElementById('opinion').value;
  const rating = parseInt(document.getElementById('rating').value);
  const status = document.getElementById('status').value;
  
  // Create new anime object
  const newAnime = {
    title,
    malId: malId ? parseInt(malId) : null,
    genres: selectedCategories.length > 0 ? selectedCategories : ['Other'],
    rating: rating || 3,
    opinions: {}
  };
  
  // Add watched by users
  watchedBy.forEach(user => {
    newAnime[user.toLowerCase()] = status;
    if (opinion) {
      newAnime.opinions[user] = opinion;
    }
  });
  
  animeData.push(newAnime);
  saveData();
  closeAddModal();
  renderAllAnime();
  
  // Reset form
  document.getElementById('addAnimeForm').reset();
});

// Toggle peak status for a user
function togglePeakStatus(anime, user) {
  const userKey = user.toLowerCase();
  if (anime[userKey] === 'Peak') {
    anime[userKey] = 'Watched';
  } else {
    anime[userKey] = 'Peak';
  }
  saveData();
  renderAllAnime();
  openDetailModal(anime);
}

// Add opinion for a user
function addOpinion(anime, user, opinionText) {
  if (!anime.opinions) {
    anime.opinions = {};
  }
  anime.opinions[user] = opinionText;
  
  // Make sure user is marked as watched if they're adding an opinion
  const userKey = user.toLowerCase();
  if (!anime[userKey] || anime[userKey] === '') {
    anime[userKey] = 'Watched';
  }
  
  saveData();
  renderAllAnime();
  openDetailModal(anime);
}

// Open detail modal
async function openDetailModal(anime) {
  currentAnime = anime;
  const imageUrl = await fetchAnimeImage(anime.title, anime.malId);
  const rating = anime.rating || 3;
  
  // Check if this anime is peak for any user
  const isPeak = anime.rayyy === 'Peak' || anime.shafaa === 'Peak';
  
  const detailBody = document.getElementById('detailBody');
  detailBody.innerHTML = `
    <img src="${imageUrl || ''}" class="anime-detail-img" alt="${anime.title}">
    <h3 class="anime-detail-title">${anime.title}</h3>
    
    <button class="peak-toggle-btn ${isPeak ? 'is-peak' : ''}" onclick="togglePeakForCurrentUser()">
      ${isPeak ? '‚úì Remove from Peak' : 'üî• Mark as Peak'}
    </button>
    
    <div class="users-opinions">
      <h4>üë• Opinions</h4>
      ${Object.keys(anime.opinions || {}).length > 0 ? 
        Object.entries(anime.opinions).map(([user, opinion]) => `
          <div class="user-oval">
            <span class="username">${user}</span>
            <span class="opinion">"${opinion}"</span>
          </div>
        `).join('') : 
        '<p style="color:#aaa;font-size:14px">No opinions yet</p>'
      }
    </div>
    
    <div class="add-opinion-section">
      <h4>üí≠ Add Your Opinion</h4>
      <div class="opinion-input-group">
        <select id="opinionUser">
          <option value="Rayyy">Rayyy</option>
          <option value="Shafaa">Shafaa</option>
        </select>
        <div class="opinion-input-row">
          <input type="text" id="opinionText" placeholder="What do you think about this anime?">
          <button onclick="submitOpinion()">Add</button>
        </div>
      </div>
    </div>
    
    <div class="rating-section">
      <h4>‚≠ê Rating</h4>
      <div class="stars">${'‚òÖ'.repeat(rating)}${'‚òÜ'.repeat(5-rating)}</div>
      <p style="color:#aaa;margin-top:8px">${rating}/5 stars</p>
    </div>
  `;
  
  document.getElementById('detailModal').classList.add('show');
}

// Toggle peak for current user (simplified - uses first available user)
function togglePeakForCurrentUser() {
  if (!currentAnime) return;
  
  // Check which user has watched it and toggle their status
  if (currentAnime.rayyy && currentAnime.rayyy !== '') {
    togglePeakStatus(currentAnime, 'Rayyy');
  } else if (currentAnime.shafaa && currentAnime.shafaa !== '') {
    togglePeakStatus(currentAnime, 'Shafaa');
  } else {
    // If no one has watched it, add it as Peak for Rayyy by default
    currentAnime.rayyy = 'Peak';
    saveData();
    renderAllAnime();
    openDetailModal(currentAnime);
  }
}

// Submit opinion
function submitOpinion() {
  const user = document.getElementById('opinionUser').value;
  const opinionText = document.getElementById('opinionText').value.trim();
  
  if (opinionText && currentAnime) {
    addOpinion(currentAnime, user, opinionText);
    document.getElementById('opinionText').value = '';
  }
}

function closeDetailModal() {
  document.getElementById('detailModal').classList.remove('show');
  currentAnime = null;
}

// Render anime cards
async function renderAllAnime() {
  peakContainer.innerHTML = '<div class="loading">Loading...</div>';
  watchedContainer.innerHTML = '<div class="loading">Loading...</div>';
  
  const peakAnime = [];
  const watchedAnime = [];
  
  for (const anime of animeData) {
    const isPeak = anime.rayyy === 'Peak' || anime.shafaa === 'Peak';
    if (isPeak) {
      peakAnime.push(anime);
    } else {
      watchedAnime.push(anime);
    }
  }
  
  // Render Peak (batch loading)
  peakContainer.innerHTML = '';
  for (let i = 0; i < peakAnime.length; i += 4) {
    const batch = peakAnime.slice(i, i + 4);
    const images = await Promise.all(batch.map(a => fetchAnimeImage(a.title, a.malId)));
    
    batch.forEach((anime, idx) => {
      const card = createCard(anime, images[idx]);
      peakContainer.appendChild(card);
    });
    
    if (i + 4 < peakAnime.length) {
      await new Promise(r => setTimeout(r, 400));
    }
  }
  
  if (peakAnime.length === 0) {
    peakContainer.innerHTML = '<p style="color:#aaa;padding:20px">No peak anime yet</p>';
  }
  
  // Render Watched (batch loading)
  watchedContainer.innerHTML = '';
  for (let i = 0; i < watchedAnime.length; i += 4) {
    const batch = watchedAnime.slice(i, i + 4);
    const images = await Promise.all(batch.map(a => fetchAnimeImage(a.title, a.malId)));
    
    batch.forEach((anime, idx) => {
      const card = createCard(anime, images[idx]);
      watchedContainer.appendChild(card);
    });
    
    if (i + 4 < watchedAnime.length) {
      await new Promise(r => setTimeout(r, 400));
    }
  }
  
  if (watchedAnime.length === 0) {
    watchedContainer.innerHTML = '<p style="color:#aaa;padding:20px">No watched anime yet</p>';
  }
}

function createCard(anime, imageUrl) {
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <img src="${imageUrl || ''}" alt="${anime.title}" class="${imageUrl ? '' : 'loading'}">
    <div class="card-content">${anime.title}</div>
  `;
  
  card.addEventListener('click', () => openDetailModal(anime));
  return card;
}

// Close modals on outside click
document.getElementById('addModal').addEventListener('click', (e) => {
  if (e.target.id === 'addModal') closeAddModal();
});

document.getElementById('detailModal').addEventListener('click', (e) => {
  if (e.target.id === 'detailModal') closeDetailModal();
});

// Data management functions
function exportData() {
  const dataStr = JSON.stringify(animeData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'my-anime-list-backup.json';
  link.click();
  URL.revokeObjectURL(url);
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const imported = JSON.parse(event.target.result);
          if (confirm(`Import ${imported.length} anime? This will replace your current list.`)) {
            animeData = imported;
            saveData();
            renderAllAnime();
            alert('Data imported successfully!');
          }
        } catch (err) {
          alert('Error importing data. Make sure the file is valid JSON.');
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
}

function resetData() {
  if (confirm('Are you sure you want to reset to default data? This cannot be undone!')) {
    if (confirm('Really sure? All your custom anime and opinions will be lost!')) {
      animeData = [...defaultAnimeData];
      saveData();
      renderAllAnime();
      alert('Data reset to defaults!');
    }
  }
}

// Initial render
renderAllAnime();
</script>
</body>
</html>
